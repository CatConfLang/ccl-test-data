#!/usr/bin/env node

import { execSync } from 'child_process';
import { writeFileSync, mkdtempSync, rmSync } from 'fs';
import { tmpdir } from 'os';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const PROJECT_ROOT = dirname(__dirname);

console.log('üèóÔ∏è  Generating JSON Schema Documentation...');

// Check if json-schema-for-humans is installed
try {
  execSync('generate-schema-doc --version', { stdio: 'ignore' });
} catch (error) {
  console.log('‚ùå json-schema-for-humans not found. Installing...');
  execSync('pip install json-schema-for-humans', { stdio: 'inherit' });
}

// Create temporary config for markdown generation
const tempDir = mkdtempSync(join(tmpdir(), 'ccl-schema-'));
const configFile = join(tempDir, 'config.json');
writeFileSync(configFile, JSON.stringify({ template_name: 'md' }));

try {
  // Generate the documentation
  console.log('üìÑ Generating docs/generated-schema.md from tests/schema.json...');
  
  const schemaPath = join(PROJECT_ROOT, 'tests', 'schema.json');
  const outputPath = join(PROJECT_ROOT, 'docs', 'generated-schema.md');
  
  execSync(`generate-schema-doc "${schemaPath}" "${outputPath}" --config-file "${configFile}"`, {
    stdio: 'inherit'
  });

  // Add header to generated file
  const header = `# CCL Unified Test Suite Schema - Technical Reference

> **ü§ñ Auto-Generated Documentation:** This file is automatically generated from \`tests/schema.json\` using [json-schema-for-humans](https://github.com/coveooss/json-schema-for-humans). It provides complete field-by-field technical documentation.

> **üõ†Ô∏è Implementation Guide:** For practical usage examples and implementation patterns, see [\`schema-reference.md\`](schema-reference.md).

---

`;

  // Read existing file and replace header
  const existingContent = execSync(`tail -n +2 "${outputPath}"`, { encoding: 'utf8' });
  writeFileSync(outputPath, header + existingContent);

  console.log('‚úÖ Schema documentation generated successfully!');
  
  // Get line count
  const lineCount = execSync(`wc -l < "${outputPath}"`, { encoding: 'utf8' }).trim();
  console.log('üìÅ Files updated:');
  console.log(`   - docs/generated-schema.md (${lineCount} lines)`);
  
  console.log('');
  console.log('üí° To regenerate documentation after schema changes:');
  console.log('   npm run docs:schema');

} finally {
  // Clean up temp directory
  rmSync(tempDir, { recursive: true, force: true });
}